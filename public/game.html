<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒˆãƒ­ãƒƒã‚³ã‚¯ã‚¤ã‚º (æœ€çµ‚ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.esm.min.js" type="module"></script>
    <style>
        /* æœ€å°é™ã®CSS */
        body { margin: 0; overflow: hidden; background-color: #333; color: white; font-family: sans-serif; }
        canvas { display: block; }
        #quiz-area { position: absolute; top: 0; width: 100%; text-align: center; z-index: 10; }
        #question-box { background: rgba(0, 0, 0, 0.8); padding: 10px; margin: 5vh auto 0; max-width: 90%; font-size: 20px; }
        #options { display: flex; justify-content: center; margin-top: 10px; font-size: 18px; }
        .option { padding: 5px 10px; margin: 0 10px; border: 1px solid white; cursor: default; }
        .selected { background-color: yellow; color: black; }
        .correct-result { background-color: green; }
        .incorrect-result { background-color: red; }
        #status-info { position: absolute; top: 10px; right: 10px; font-size: 16px; }
        .full-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 50; }
        #timer { font-size: 30px; margin-bottom: 5px; }
        
        /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚²ãƒ¼ã‚¸ç”¨ */
        #shake-gauge-container { width: 80%; max-width: 300px; height: 20px; background: #555; border: 1px solid white; margin-top: 10px; }
        #shake-gauge { height: 100%; width: 0%; background: #ff5722; transition: width 0.1s; }
    </style>
</head>
<body>
    <div id="quiz-area">
        <div id="status-info">
            <div id="life">ãƒ©ã‚¤ãƒ•: 3</div>
            <div id="score">ã‚¹ã‚³ã‚¢: 0</div>
        </div>
        <div id="timer"></div>
        <div id="question-box">
            <div id="question"></div>
            <div id="options">
                <span id="left-option" class="option"></span>
                <span id="right-option" class="option"></span>
            </div>
        </div>
        <div id="message" style="margin-top: 10px; font-size: 24px;"></div>
    </div>

    <div id="start-screen" class="full-screen">
        <div style="font-size: 30px;">ãƒˆãƒ­ãƒƒã‚³ãƒ»ã‚µãƒã‚¤ãƒãƒ«ãƒ»ã‚¯ã‚¤ã‚ºï¼</div>
        <div id="mode-display" style="margin: 10px;">é›£æ˜“åº¦: ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«</div>
        <div style="margin: 20px;">ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ã¦é–‹å§‹</div>
        <div style="font-size: 14px;">[å³â†’å·¦â†’å³]ã¨å‚¾ã‘ã¦é›£æ˜“åº¦å¤‰æ›´å¯èƒ½</div>
    </div>

    <div id="result-overlay" class="full-screen" style="display: none;">
        <div id="result-message" style="font-size: 40px;"></div>
        <div id="result-answer" style="font-size: 20px; margin-top: 10px;"></div>
        <div id="result-retry-message" style="font-size: 20px; margin-top: 20px; display: none;">ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ã¦ãƒªãƒˆãƒ©ã‚¤ï¼</div>
    </div>
    
    <div id="gameover-screen" class="full-screen" style="display: none;">
        <div style="font-size: 50px; color: red;">GAME OVER</div>
        <div id="gameover-score" style="margin-top: 20px;"></div>
        <div id="retry-message" style="margin-top: 20px;">å†æŒ‘æˆ¦ï¼ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’æŒ¯ã£ã¦ã‚²ãƒ¼ã‚¸ã‚’æº€ã‚¿ãƒ³ã«ã›ã‚ˆï¼</div>
        <div id="shake-gauge-container"><div id="shake-gauge"></div></div>
    </div>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.5.1/socket.io.esm.min.js";
        
        // --- å®šæ•°å®šç¾© ---
        const SHAKE_THRESHOLD = 15;
        const SECRET_COMMAND_SEQUENCE = ['R', 'L', 'R'];
        const SECRET_COMMAND_THRESHOLD = 15;
        const GAUGE_MAX = 5;

        let game; // p5.jsã®setupã§åˆæœŸåŒ–ã•ã‚Œã‚‹ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

        // ----------------------------------------------------
        // p5.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨æç”»
        // ----------------------------------------------------

        window.setup = function() {
            createCanvas(windowWidth, windowHeight, WEBGL);
            angleMode(DEGREES);
            game = new TrocoQuizGame();
        }

        window.draw = function() {
            game.update();
            game.display();
        }

        window.windowResized = function() {
            resizeCanvas(windowWidth, windowHeight);
        }

        /**
         * ãƒˆãƒ­ãƒƒã‚³ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
         */
        class TrocoQuizGame {
            constructor() {
                // UIè¦ç´ ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åŒ–
                this.ui = {
                    leftOption: document.getElementById('left-option'),
                    rightOption: document.getElementById('right-option'),
                    resultOverlay: document.getElementById('result-overlay'),
                    resultMsg: document.getElementById('result-message'),
                    resultAns: document.getElementById('result-answer'),
                    life: document.getElementById('life'),
                    score: document.getElementById('score'),
                    gameoverScreen: document.getElementById('gameover-screen'),
                    gameoverScore: document.getElementById('gameover-score'),
                    startScreen: document.getElementById('start-screen'),
                    message: document.getElementById('message'),
                    timer: document.getElementById('timer'),
                    shakeGauge: document.getElementById('shake-gauge'),
                    modeDisplay: document.getElementById('mode-display'),
                    resultRetryMsg: document.getElementById('result-retry-message'),
                    topInfo: document.getElementById('quiz-area'),
                    question: document.getElementById('question')
                };

                // ã‚»ãƒ³ã‚µãƒ¼å€¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åŒ–
                this.sensor = {
                    gamma: 0,
                    z: 0,
                    lastZ: 0,
                    isShakeDetected: false,
                    shakeCount: 0,
                    secretCommandLog: []
                };

                // å•é¡Œå®šç¾©
                this.normalQuestions = [
                    { q: "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒç†è§£ã§ãã‚‹è¨€èªã¯ï¼Ÿ", options: ["Python", "æ©Ÿæ¢°èª"], correct: "æ©Ÿæ¢°èª" },
                    { q: "Webãƒšãƒ¼ã‚¸ã«ä½¿ã‚ã‚Œã‚‹ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªã¯ï¼Ÿ", options: ["Java", "HTML"], correct: "HTML" },
                    { q: "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªæ‰‹é †ã¯ï¼Ÿ", options: ["ãƒ—ãƒ­ãƒˆã‚³ãƒ«", "ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ "], correct: "ãƒ—ãƒ­ãƒˆã‚³ãƒ«" },
                    { q: "ãƒ‡ãƒ¼ã‚¿ã‚’æ”¹ã–ã‚“ã‹ã‚‰å®ˆã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã¯ï¼Ÿ", options: ["æ©Ÿå¯†æ€§", "å®Œå…¨æ€§"], correct: "å®Œå…¨æ€§" },
                    { q: "1ãƒã‚¤ãƒˆã¯ä½•ãƒ“ãƒƒãƒˆã‹ï¼Ÿ", options: ["4ãƒ“ãƒƒãƒˆ", "8ãƒ“ãƒƒãƒˆ"], correct: "8ãƒ“ãƒƒãƒˆ" },
                    { q: "ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’æ„å‘³ã™ã‚‹ç•¥èªã¯ï¼Ÿ", options: ["PaaS", "SaaS"], correct: "SaaS" },
                ];
                this.hardQuestions = [
                    { q: "æ¬¡ä¸–ä»£ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ï¼Ÿ", options: ["IPv5", "IPv6"], correct: "IPv6" },
                    { q: "å…ˆå…¥ã‚Œå…ˆå‡ºã—ï¼ˆFIFOï¼‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ï¼Ÿ", options: ["ã‚¹ã‚¿ãƒƒã‚¯", "ã‚­ãƒ¥ãƒ¼"], correct: "ã‚­ãƒ¥ãƒ¼" },
                    { q: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œå‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ãªè¨€èªã¯ï¼Ÿ", options: ["Python", "Cè¨€èª"], correct: "Cè¨€èª" },
                    { q: "å†…éƒ¨æ§‹é€ ã‚’è¦‹ãšã«å¤–éƒ¨ä»•æ§˜ã‹ã‚‰æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆæ‰‹æ³•ã¯ï¼Ÿ", options: ["ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹", "ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹"], correct: "ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹" },
                    { q: "æ•…éšœã‹ã‚‰å¾©æ—§ã¾ã§ã®å¹³å‡æ™‚é–“ã‚’æ„å‘³ã™ã‚‹ç•¥èªã¯ï¼Ÿ", options: ["MTBF", "MTTR"], correct: "MTTR" },
                    { q: "RDBã§ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®é–¢é€£ä»˜ã‘ã«ä½¿ã†ã‚­ãƒ¼ã¯ï¼Ÿ", options: ["ä¸»ã‚­ãƒ¼", "å¤–éƒ¨ã‚­ãƒ¼"], correct: "å¤–éƒ¨ã‚­ãƒ¼" },
                ];
                
                this.isHardMode = false;
                this.totalQuestions = 5;
                this.trolleyRotationTarget = 0;
                
                this.initSocket();
                this.initGame();
            }

            // ã‚½ã‚±ãƒƒãƒˆã¨ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–ã‚’ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰åŒ–
            initSocket() {
                const socket = io();
                socket.emit('join', 'game');

                socket.on('sensor', (data) => {
                    this.sensor.gamma = parseFloat(data.g);
                    this.sensor.z = parseFloat(data.z);

                    if (this.state === 'WAITING') {
                        this.logSecretCommandDirection(this.sensor.gamma);
                    }
                    
                    if (Math.abs(this.sensor.z - this.sensor.lastZ) > SHAKE_THRESHOLD && !this.sensor.isShakeDetected) {
                        this.sensor.isShakeDetected = true;
                        this.handleShake();
                        setTimeout(() => { this.sensor.isShakeDetected = false; }, 500);
                    }
                    this.sensor.lastZ = this.sensor.z;
                });
            }

            // --- ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ---

            toggleHardMode() {
                this.isHardMode = !this.isHardMode;
                this.updateModeDisplay();
                alert(this.isHardMode ? "ğŸ”¥ å¿œç”¨å•é¡Œãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸï¼" : "âœ… ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸï¼");
            }

            initGame() {
                this.state = 'WAITING';
                this.trolleyZ = 0;
                this.cameraZ = 150;
                this.score = 0;
                this.life = 3;
                this.questionStartTime = 0;
                this.timeLimit = 15;
                this.trolleyRotation = 0;
                this.trolleyRotationTarget = 0;
                this.currentQuestionIndex = -1; 
                this.sensor.shakeCount = 0; // ãƒªãƒˆãƒ©ã‚¤ã‚²ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ
                this.sensor.secretCommandLog = []; // ã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚°ãƒªã‚»ãƒƒãƒˆ

                // ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ãŸå•é¡Œã‚»ãƒƒãƒˆã®é¸æŠã¨ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                const source = this.isHardMode ? this.hardQuestions : this.normalQuestions;
                const shuffled = source.sort(() => 0.5 - Math.random());
                this.currentQuizSet = shuffled.slice(0, this.totalQuestions);

                // UIã®ãƒªã‚»ãƒƒãƒˆ
                this.ui.startScreen.style.display = 'flex';
                this.ui.gameoverScreen.style.display = 'none';
                this.ui.resultOverlay.style.display = 'none';
                this.ui.topInfo.style.display = 'block';
                this.ui.question.innerText = '';
                this.ui.leftOption.innerText = '';
                this.ui.rightOption.innerText = '';
                this.ui.message.innerText = '';
                this.ui.timer.innerText = '';
                
                this.updateStatusDisplay();
                this.updateModeDisplay();
            }

            nextQuestion() {
                if (this.life <= 0) {
                    this.state = 'GAMEOVER';
                    this.showGameoverScreen();
                    return;
                }

                if (this.currentQuestionIndex >= this.totalQuestions - 1) { 
                    this.state = 'RESULT';
                    this.showResultOverlay(true, true);
                    return;
                }

                this.currentQuestionIndex++;
                const qData = this.currentQuizSet[this.currentQuestionIndex];
                qData.options.sort(() => random() - 0.5);

                this.currentQuestion = qData;
                this.correctOption = qData.correct;
                this.selectedOption = null;
                this.questionStartTime = millis();
                this.state = 'ASKING';
                this.ui.message.innerText = 'é€²è·¯ã‚’é¸æŠã—ã€æŒ¯ã£ã¦ç¢ºå®šï¼';
                this.updateQuestionDisplay();
                this.hideResultOverlay();
            }

            processAnswer(isShaken) {
                if (this.state !== 'ASKING') return;

                this.state = 'MOVING';

                let selectionIndex = this.sensor.gamma > 15 ? 1 : (this.sensor.gamma < -15 ? 0 : null);
                
                if (selectionIndex === null) {
                    selectionIndex = floor(random(2));
                }

                this.selectedOption = this.currentQuestion.options[selectionIndex];
                const isCorrect = this.selectedOption === this.correctOption;

                if (isCorrect) {
                    this.score++;
                } else {
                    this.life--;
                }
                this.updateStatusDisplay();

                this.showResultOverlay(isCorrect);
                
                this.trolleyRotationTarget = selectionIndex === 1 ? 60 : -60;

                setTimeout(() => {
                    this.trolleyRotationTarget = 0;
                    this.nextQuestion();
                }, 3000);
            }

            // --- ã‚»ãƒ³ã‚µãƒ¼å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ ---

            handleShake() {
                if (this.state === 'WAITING') {
                    this.state = 'ASKING';
                    this.ui.startScreen.style.display = 'none';
                    this.nextQuestion();
                } else if (this.state === 'ASKING') {
                    this.processAnswer(true);
                } else if (this.state === 'GAMEOVER') {
                    this.handleRetryShake();
                } else if (this.state === 'RESULT') {
                    this.initGame();
                }
            }

            handleRetryShake() {
                this.sensor.shakeCount = Math.min(GAUGE_MAX, this.sensor.shakeCount + 1);
                this.ui.shakeGauge.style.width = `${(this.sensor.shakeCount / GAUGE_MAX) * 100}%`;

                if (this.sensor.shakeCount >= GAUGE_MAX) {
                    this.initGame();
                }
            }

            logSecretCommandDirection(gamma) {
                let direction = null;
                if (gamma > SECRET_COMMAND_THRESHOLD) {
                    direction = 'R';
                } else if (gamma < -SECRET_COMMAND_THRESHOLD) {
                    direction = 'L';
                }
                
                if (direction) {
                    const log = this.sensor.secretCommandLog;
                    if (log.length === 0 || log[log.length - 1] !== direction) {
                        log.push(direction);
                        
                        if (log.length > SECRET_COMMAND_SEQUENCE.length * 2) {
                            this.sensor.secretCommandLog = log.slice(-SECRET_COMMAND_SEQUENCE.length);
                        }

                        if (log.slice(-SECRET_COMMAND_SEQUENCE.length).join('') === SECRET_COMMAND_SEQUENCE.join('')) {
                            this.toggleHardMode();
                            this.initGame(); 
                            this.sensor.secretCommandLog = [];
                        }
                    }
                }
            }

            // --- UI/è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---

            updateStatusDisplay() {
                this.ui.life.innerText = `ãƒ©ã‚¤ãƒ•: ${this.life}`;
                this.ui.score.innerText = `ã‚¹ã‚³ã‚¢: ${this.score}`;
            }

            updateModeDisplay() {
                this.ui.modeDisplay.innerText = `é›£æ˜“åº¦: ${this.isHardMode ? 'å¿œç”¨æƒ…å ±æŠ€è¡“è€…ãƒ¬ãƒ™ãƒ«' : 'ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«'}`;
            }

            updateQuestionDisplay() {
                if (!this.currentQuestion) return;
                this.ui.question.innerHTML = `Q${this.currentQuestionIndex + 1}/${this.totalQuestions}: ${this.currentQuestion.q}`;
                this.ui.leftOption.innerText = 'â† ' + (this.currentQuestion.options[0] || '');
                this.ui.rightOption.innerText = (this.currentQuestion.options[1] || '') + ' â†’';
            }

            showResultOverlay(isCorrect, isClear = false) {
                this.ui.topInfo.style.display = 'none';
                this.ui.resultOverlay.style.display = 'flex';
                this.ui.resultRetryMsg.style.display = 'none';

                if (isClear) {
                    this.ui.resultMsg.innerText = 'âœ¨ å…¨å•ã‚¯ãƒªã‚¢ï¼âœ¨';
                    this.ui.resultAns.innerHTML = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${this.score}/${this.totalQuestions} (${this.isHardMode ? 'å¿œç”¨' : 'åŸºç¤'}ãƒ¢ãƒ¼ãƒ‰)`;
                    this.ui.resultRetryMsg.style.display = 'block';
                    this.ui.resultOverlay.style.backgroundColor = 'rgba(255, 140, 0, 0.9)';
                } else {
                    this.ui.resultMsg.innerText = isCorrect ? 'ğŸ‰ æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£...';
                    this.ui.resultAns.innerHTML = `æ­£è§£: ${this.correctOption}`;
                    this.ui.resultOverlay.style.backgroundColor = isCorrect ? 'rgba(0, 100, 0, 0.9)' : 'rgba(100, 0, 0, 0.9)';
                }

                // UIãƒã‚¤ãƒ©ã‚¤ãƒˆ
                const leftOption = this.currentQuestion.options[0];
                const rightOption = this.currentQuestion.options[1];
                this.ui.leftOption.className = 'option';
                this.ui.rightOption.className = 'option';
                if (this.selectedOption === leftOption) {
                    this.ui.leftOption.classList.add(isCorrect ? 'correct-result' : 'incorrect-result');
                } else if (this.selectedOption === rightOption) {
                    this.ui.rightOption.classList.add(isCorrect ? 'correct-result' : 'incorrect-result');
                }
            }

            hideResultOverlay() {
                this.ui.topInfo.style.display = 'block';
                this.ui.resultOverlay.style.display = 'none';
                this.ui.leftOption.className = 'option';
                this.ui.rightOption.className = 'option';
            }

            showGameoverScreen() {
                this.ui.topInfo.style.display = 'none';
                this.ui.gameoverScreen.style.display = 'flex';
                this.ui.gameoverScore.innerHTML = `ã‚¹ã‚³ã‚¢: ${this.score}/${this.totalQuestions} (${this.isHardMode ? 'å¿œç”¨' : 'åŸºç¤'}ãƒ¢ãƒ¼ãƒ‰)`;
                this.ui.shakeGauge.style.width = '0%';
            }

            // --- p5.js ãƒ«ãƒ¼ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ ---
            
            update() {
                if (this.state === 'GAMEOVER' || this.state === 'WAITING' || this.state === 'RESULT') return;

                this.trolleyZ -= 1; 
                this.cameraZ = lerp(this.cameraZ, this.trolleyZ + 200, 0.1);
                this.trolleyRotation = lerp(this.trolleyRotation, this.trolleyRotationTarget, 0.1);

                if (this.state === 'ASKING') {
                    // å‚¾ãé€£å‹•ã§ãƒˆãƒ­ãƒƒã‚³ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå›è»¢ã‚’è¨­å®š
                    this.trolleyRotationTarget = this.sensor.gamma;

                    // ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†
                    const elapsedTime = (millis() - this.questionStartTime) / 1000;
                    const remainingTime = max(0, this.timeLimit - floor(elapsedTime));
                    this.ui.timer.innerText = remainingTime;

                    if (remainingTime <= 0) {
                        this.processAnswer(false); 
                        this.ui.message.innerText = 'â° ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼ä¸æ­£è§£';
                        this.selectedOption = 'ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—';
                        this.trolleyRotationTarget = 0;
                    }

                    // å‚¾ãã«ã‚ˆã‚‹UIé¸æŠå¼·èª¿
                    this.ui.leftOption.className = 'option';
                    this.ui.rightOption.className = 'option';
                    if (this.sensor.gamma < -15) {
                        this.ui.leftOption.classList.add('selected');
                    } else if (this.sensor.gamma > 15) {
                        this.ui.rightOption.classList.add('selected');
                    }
                }
            }

            display() {
                background(30, 40, 70);

                camera(0, -50, this.cameraZ,
                        0, 0, this.trolleyZ,
                        0, 1, 0);

                directionalLight(200, 200, 255, 0, 1, 0);

                this.drawRails();

                push();
                translate(0, 15, this.trolleyZ);
                rotateZ(this.trolleyRotation);
                this.drawTrolley();
                pop();
            }

            drawTrolley() {
                specularMaterial(150, 75, 0);
                box(50, 30, 80);

                const wheelRotation = (this.trolleyZ * 0.5) * 50;
                specularMaterial(100);
                for (let i = -1; i <= 1; i += 2) {
                    for (let j = -1; j <= 1; j += 2) {
                        push();
                        translate(i * 30, 0, j * 30);
                        rotateX(wheelRotation); 
                        cylinder(10, 10);
                        pop();
                    }
                }
            }

            drawRails() {
                specularMaterial(100);
                const railSpacing = 30;
                const renderDistance = 1000;

                for (let i = -1; i <= 1; i += 2) {
                    push();
                    translate(i * railSpacing, 0, this.trolleyZ - renderDistance / 2);
                    box(5, 5, renderDistance);
                    pop();
                }

                specularMaterial(150, 75, 0);
                for (let z = this.trolleyZ + 10; z > this.trolleyZ - renderDistance; z -= 30) {
                    push();
                    translate(0, 0, z);
                    box(70, 5, 5); 
                    pop();
                }
            }
        }
    </script>
</body>
</html>